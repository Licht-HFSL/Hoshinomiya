<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Character Detail</title>
  <link rel="stylesheet" href="chara.css" />
</head>

<body>
  <!-- ヘッダー -->
  <header class="site-header">
    <a class="back" href="characters.html">← キャラ一覧へ</a>
    <h1 id="page-title">キャラクター詳細</h1>
  </header>

  <!-- メインコンテナ: 左立ち絵 / 右カード -->
  <main id="character-page" class="container">
    
    <!-- 左: 立ち絵 -->
    <!-- メモ: CSSで縦長全身対応 -->
    <aside class="portrait-wrap">
      <img id="char-image" src="" alt="キャラクター立ち絵" />
    </aside>

    <!-- 右: 情報カード -->
    <aside class="profile-card">
      <h2 id="char-name">—</h2>
      <p id="char-title" class="muted">—</p>

      <div class="meta-grid">
        <div><strong>世界</strong><div id="char-world" class="muted">—</div></div>
        <div><strong>所属</strong><div id="char-affiliation" class="muted">—</div></div>
        <div><strong>誕生日</strong><div id="char-birthday" class="muted">—</div></div>
        <div><strong>年齢</strong><div id="char-age" class="muted">—</div></div>
      </div>

      <div class="tags" id="char-tags"></div>

      <!-- 性格・目的 -->
      <section class="panel two-col">
        <div>
          <h3>性格</h3>
          <p id="char-personality">—</p>
        </div>
        <div>
          <h3>目的</h3>
          <p id="char-motivation">—</p>
        </div>
      </section>

      <!-- 経歴 / 背景 -->
      <section class="panel">
        <h3>経歴 / 背景</h3>
        <p id="char-background">—</p>
      </section>

      <!-- スキル -->
      <section class="panel">
        <h3>スキル・装備</h3>
        <ul id="char-skills" class="list-plain"></ul>
      </section>

      <!-- 関係 -->
      <section class="panel">
        <h3>関係</h3>
        <ul id="char-relations" class="list-relations"></ul>
      </section>

      <!-- 台詞・名言 -->
      <section class="panel">
        <h3>台詞・名言</h3>
        <ul id="char-quotes" class="list-quotes"></ul>
      </section>

      <!-- 登場履歴 -->
      <section class="panel">
        <h3>登場履歴</h3>
        <div id="char-stories"></div>
      </section>

      <!-- ギャラリー -->
      <section class="panel">
        <h3>ギャラリー</h3>
        <div id="char-gallery" class="gallery"></div>
      </section>

      <!-- メモ / Voice -->
      <section class="panel muted small">
        <div><strong>Voice / BGM</strong> <span id="char-voice">—</span></div>
        <div><strong>メモ</strong> <span id="char-notes">—</span></div>
      </section>
    </aside>
  </main>

  <!-- JS: キャラデータ読み込み -->
  <script>
    (() => {
      const qs = new URLSearchParams(location.search);
      const id = qs.get('id');
      const IDsafe = id ? id.trim() : '';

      function setText(id, text) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = text ?? '';
      }

      function clearChildren(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function hideSectionIfEmpty(elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        let isEmpty = (el.tagName === 'UL' || el.tagName === 'DIV') ? el.children.length === 0 : !el.textContent.trim();
        const section = el.closest('section');
        if (section) section.style.display = isEmpty ? 'none' : '';
      }

      fetch('characters.json')
        .then(r => r.ok ? r.json() : Promise.reject('characters.json not found'))
        .then(list => {
          if (!IDsafe) {
            document.getElementById('page-title').textContent = 'キャラIDが指定されていません';
            setText('char-name', 'IDがないため表示できません');
            return;
          }

          const c = list.find(x => x.id === IDsafe);
          if (!c) {
            document.getElementById('page-title').textContent = 'キャラが見つかりません';
            setText('char-name', '該当するキャラが存在しません');
            return;
          }

          // 基本情報
          setText('char-name', c.name || '');
          setText('char-title', c.title || '');
          setText('char-world', c.world || '');
          setText('char-affiliation', c.affiliation || '');
          setText('char-birthday', c.birthday || '');
          setText('char-age', c.age || '');

          // 立ち絵
          const img = document.getElementById('char-image');
          img.src = c.appearance || 'placeholder.png';
          img.alt = c.name || 'character image';

          // タグ
          const tagWrap = document.getElementById('char-tags');
          clearChildren(tagWrap);
          (c.tags || []).forEach(t => {
            const b = document.createElement('div');
            b.className = 'tag';
            b.textContent = t;
            tagWrap.appendChild(b);
          });

          // 詳細
          setText('char-personality', c.personality || '');
          setText('char-motivation', c.motivation || '');
          setText('char-background', c.background || '');

          // スキル
          const skills = document.getElementById('char-skills');
          clearChildren(skills);
          (c.skills || []).forEach(s => {
            const li = document.createElement('li');
            li.textContent = s;
            skills.appendChild(li);
          });

          // 台詞・名言
          const qlist = document.getElementById('char-quotes');
          clearChildren(qlist);
          (c.quotes || []).forEach(q => {
            const li = document.createElement('li');
            li.className = 'quote';
            li.textContent = q;
            qlist.appendChild(li);
          });

          // ギャラリー
          const gallery = document.getElementById('char-gallery');
          clearChildren(gallery);
          (c.gallery || []).forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.alt = c.name + ' gallery';
            gallery.appendChild(img);
          });

          setText('char-voice', [c.voice, c.theme_song].filter(Boolean).join(' • ') || '');
          setText('char-notes', c.notes || '');

          // 背景テーマ
          document.body.classList.add(`world-${(c.world || 'default').replace(/\s+/g, '-')}`);

          // 空セクション非表示
          const sectionIds = [
            'char-personality', 'char-motivation', 'char-background',
            'char-skills', 'char-relations', 'char-quotes', 'char-stories',
            'char-gallery', 'char-voice', 'char-notes'
          ];
          sectionIds.forEach(hideSectionIfEmpty);

        })
        .catch(err => {
          console.error(err);
          document.getElementById('page-title').textContent = '読み込みエラー';
          setText('char-name', 'データの読み込みに失敗しました');
        });
    })();
  </script>
</body>
</html>
